<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Match Stats Tracker</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 12px;
      background: #fafafa;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    input, button {
      font-size: 16px;
      padding: 10px;
    }

    button {
      min-height: 48px;
      cursor: pointer;
    }

    .section {
      background: white;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .match-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .match-details input {
      width: 100%;
    }

    .clock {
      text-align: center;
      font-size: 32px;
      margin: 10px 0;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #f2f2f2;
    }

    .stat-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .timeline table {
      font-size: 13px;
    }

    @media (max-width: 600px) {
      .match-details {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

<h2>Match Stats</h2>

<div class="section match-details">
  <input id="myTeam" placeholder="My Team">
  <input id="opponent" placeholder="Opponent">
  <input id="date" type="date">
  <input id="venue" placeholder="Venue">
</div>

<div class="section">
  <div class="clock" id="clock">00:00</div>
  <div class="controls">
    <button id="startStop">Start Match</button>
    <button id="reset">Reset Match</button>
    <button id="export">Export CSV</button>
  </div>
</div>

<div class="section">
  <table>
    <thead>
      <tr>
        <th>My</th>
        <th>Stat</th>
        <th>Opp</th>
      </tr>
    </thead>
    <tbody id="statsBody"></tbody>
  </table>
</div>

<div class="section timeline">
  <h3>Timeline</h3>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Event</th>
      </tr>
    </thead>
    <tbody id="timelineBody"></tbody>
  </table>
</div>

<script>
/* ---------------- STATE ---------------- */

let state = {
  running: false,
  minutes: 0,
  seconds: 0,
  stats: {},
  timeline: [],
  info: {}
};

/* ---------------- CONSTANTS ---------------- */

const STAT_LIST = [
  "Goal",
  "Shot",
  "On Target",
  "Corner",
  "Foul"
];

/* ---------------- DOM ---------------- */

const clockEl = document.getElementById("clock");
const startStopBtn = document.getElementById("startStop");
const resetBtn = document.getElementById("reset");
const exportBtn = document.getElementById("export");
const statsBody = document.getElementById("statsBody");
const timelineBody = document.getElementById("timelineBody");

const myTeamInput = document.getElementById("myTeam");
const opponentInput = document.getElementById("opponent");
const dateInput = document.getElementById("date");
const venueInput = document.getElementById("venue");

let timer = null;

/* ---------------- INIT ---------------- */

STAT_LIST.forEach(stat => {
  state.stats[stat] = { my: 0, opp: 0 };
  const row = document.createElement("tr");

  row.innerHTML = `
    <td class="stat-buttons">
      <button onclick="changeStat('${stat}','my',-1)">-</button>
      <span id="${stat}-my">0</span>
      <button onclick="changeStat('${stat}','my',1)">+</button>
    </td>
    <td>${stat}</td>
    <td class="stat-buttons">
      <button onclick="changeStat('${stat}','opp',-1)">-</button>
      <span id="${stat}-opp">0</span>
      <button onclick="changeStat('${stat}','opp',1)">+</button>
    </td>
  `;
  statsBody.appendChild(row);
});

load();

/* ---------------- CLOCK ---------------- */

function tick() {
  state.seconds++;
  if (state.seconds >= 60) {
    state.seconds = 0;
    state.minutes++;
  }
  updateClock();
  save();
}

function updateClock() {
  clockEl.textContent =
    String(state.minutes).padStart(2,"0") + ":" +
    String(state.seconds).padStart(2,"0");
}

/* ---------------- CONTROLS ---------------- */

startStopBtn.onclick = () => {
  state.running = !state.running;
  startStopBtn.textContent = state.running ? "Stop Match" : "Start Match";

  if (state.running) {
    timer = setInterval(tick, 1000);
    log("Match Started");
  } else {
    clearInterval(timer);
    log("Match Stopped");
  }
  save();
};

resetBtn.onclick = () => {
  if (!confirm("Reset match?")) return;
  localStorage.removeItem("matchState");
  location.reload();
};

/* ---------------- STATS ---------------- */

function changeStat(stat, side, delta) {
  state.stats[stat][side] = Math.max(0, state.stats[stat][side] + delta);
  document.getElementById(`${stat}-${side}`).textContent = state.stats[stat][side];
  log(`${side === "my" ? myTeamInput.value || "My Team" : opponentInput.value || "Opponent"} ${stat}`);
  save();
}

/* ---------------- TIMELINE ---------------- */

function log(text) {
  const time = clockEl.textContent;
  state.timeline.push({ time, text });
  renderTimeline();
}

function renderTimeline() {
  timelineBody.innerHTML = "";
  state.timeline.forEach(e => {
    const row = document.createElement("tr");
    row.innerHTML = `<td>${e.time}</td><td>${e.text}</td>`;
    timelineBody.appendChild(row);
  });
}

/* ---------------- STORAGE ---------------- */

function save() {
  state.info = {
    myTeam: myTeamInput.value,
    opponent: opponentInput.value,
    date: dateInput.value,
    venue: venueInput.value
  };
  localStorage.setItem("matchState", JSON.stringify(state));
}

function load() {
  const saved = localStorage.getItem("matchState");
  if (!saved) return;

  state = JSON.parse(saved);

  myTeamInput.value = state.info.myTeam || "";
  opponentInput.value = state.info.opponent || "";
  dateInput.value = state.info.date || "";
  venueInput.value = state.info.venue || "";

  Object.keys(state.stats).forEach(stat => {
    document.getElementById(`${stat}-my`).textContent = state.stats[stat].my;
    document.getElementById(`${stat}-opp`).textContent = state.stats[stat].opp;
  });

  updateClock();
  renderTimeline();

  if (state.running) {
    startStopBtn.textContent = "Stop Match";
    timer = setInterval(tick, 1000);
  }
}

/* ---------------- EXPORT ---------------- */

exportBtn.onclick = () => {
  let csv = "Time,Event\n";
  state.timeline.forEach(e => csv += `${e.time},${e.text}\n`);

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "match_stats.csv";
  a.click();
};

/* ---------------- SERVICE WORKER ---------------- */

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
