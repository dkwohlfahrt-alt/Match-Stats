<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Match Stats Tracker</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 12px;
}

h2, h3 {
  text-align: center;
  margin: 8px 0;
}

.section {
  background: white;
  padding: 12px;
  margin-bottom: 14px;
  border-radius: 8px;
}

input, button, select {
  font-size: 16px;
  padding: 10px;
}

button {
  min-height: 48px;
  width: 100%;
  margin-top: 6px;
}

.clock {
  font-size: 32px;
  text-align: center;
  margin: 10px 0;
}

.badge {
  text-align: center;
  font-weight: bold;
  margin-bottom: 6px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
}

th {
  background: #eee;
}
</style>
</head>

<body>

<h2>Match Stats</h2>

<div class="section">
  <select id="matchSelector"></select>
  <button onclick="newMatch()">âž• New Match</button>
</div>

<div class="section">
  <input id="myTeam" placeholder="My Team">
  <input id="opponent" placeholder="Opponent">
</div>

<div class="section">
  <div class="badge" id="phaseLabel">PRE MATCH</div>
  <div class="clock" id="clock">00:00</div>
  <button id="phaseButton">Start First Half</button>
</div>

<div class="section">
  <h3>Lineup</h3>
  <input id="playerName" placeholder="Player name">
  <button onclick="addPlayer()">Add Player</button>

  <table>
    <thead>
      <tr>
        <th>Player</th>
        <th>Status</th>
        <th>Minutes</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="lineupBody"></tbody>
  </table>
</div>

<div class="section">
  <h3>Timeline</h3>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Event</th>
      </tr>
    </thead>
    <tbody id="timelineBody"></tbody>
  </table>
</div>

<div class="section">
  <button onclick="exportMinutes()">ðŸ“¤ Export Minutes CSV</button>
</div>

<script>
/* ---------- STORAGE STRUCTURE ---------- */

let matches = JSON.parse(localStorage.getItem("matches") || "[]");
let currentMatchId = localStorage.getItem("currentMatchId");

/* ---------- MATCH TEMPLATE ---------- */

function createMatch() {
  return {
    id: Date.now(),
    info: { myTeam: "", opponent: "" },
    phase: "PRE_MATCH",
    secondsElapsed: 0,
    players: [],
    timeline: []
  };
}

/* ---------- ACTIVE MATCH ---------- */

let match = null;
let timer = null;

/* ---------- DOM ---------- */

const clockEl = document.getElementById("clock");
const phaseLabel = document.getElementById("phaseLabel");
const phaseButton = document.getElementById("phaseButton");
const lineupBody = document.getElementById("lineupBody");
const timelineBody = document.getElementById("timelineBody");
const matchSelector = document.getElementById("matchSelector");

const myTeamInput = document.getElementById("myTeam");
const opponentInput = document.getElementById("opponent");
const playerNameInput = document.getElementById("playerName");

/* ---------- MATCH SELECTION ---------- */

function refreshMatchSelector() {
  matchSelector.innerHTML = "";
  matches.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.info.myTeam || "Match"} vs ${m.info.opponent || ""}`;
    matchSelector.appendChild(opt);
  });
  matchSelector.value = currentMatchId;
}

matchSelector.onchange = () => {
  loadMatch(matchSelector.value);
};

/* ---------- NEW MATCH ---------- */

function newMatch() {
  if (match && !confirm("Start a new match? Current match will be saved.")) return;
  match = createMatch();
  matches.push(match);
  currentMatchId = match.id;
  persist();
  loadMatch(match.id);
}

/* ---------- LOAD ---------- */

function loadMatch(id) {
  match = matches.find(m => m.id == id);
  if (!match) return;

  currentMatchId = id;
  persist();

  myTeamInput.value = match.info.myTeam;
  opponentInput.value = match.info.opponent;

  updateClock();
  updatePhaseUI();
  renderLineup();
  renderTimeline();

  if (timer) clearInterval(timer);
  if (match.phase === "FIRST_HALF" || match.phase === "SECOND_HALF") {
    timer = setInterval(tick, 1000);
  }
}

/* ---------- CLOCK ---------- */

function tick() {
  match.secondsElapsed++;
  updateClock();
  persist();
}

function updateClock() {
  const m = Math.floor(match.secondsElapsed / 60);
  const s = match.secondsElapsed % 60;
  clockEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ---------- PHASE CONTROL ---------- */

phaseButton.onclick = () => {
  if (match.phase === "PRE_MATCH") startHalf("FIRST_HALF");
  else if (match.phase === "FIRST_HALF") endHalf("HALF_TIME");
  else if (match.phase === "HALF_TIME") startHalf("SECOND_HALF");
  else if (match.phase === "SECOND_HALF") endHalf("FULL_TIME");
};

function startHalf(phase) {
  match.phase = phase;
  match.players.forEach(p => {
    if (p.on) p.lastOn = match.secondsElapsed;
  });
  timer = setInterval(tick, 1000);
  log(`${phase.replace("_"," ")} started`);
  updatePhaseUI();
  persist();
}

function endHalf(nextPhase) {
  closeMinutes();
  clearInterval(timer);
  match.phase = nextPhase;
  log(`${nextPhase.replace("_"," ")}`);
  updatePhaseUI();
  persist();
}

function updatePhaseUI() {
  phaseLabel.textContent = match.phase.replace("_"," ");
  phaseButton.textContent =
    match.phase === "PRE_MATCH" ? "Start First Half" :
    match.phase === "FIRST_HALF" ? "End First Half" :
    match.phase === "HALF_TIME" ? "Start Second Half" :
    match.phase === "SECOND_HALF" ? "End Match" :
    "Match Complete";
  phaseButton.disabled = match.phase === "FULL_TIME";
}

/* ---------- PLAYERS ---------- */

function addPlayer() {
  const name = playerNameInput.value.trim();
  if (!name) return;

  match.players.push({
    name,
    on: true,
    minutes: 0,
    lastOn: match.secondsElapsed
  });

  log(`${name} added`);
  playerNameInput.value = "";
  renderLineup();
  persist();
}

function togglePlayer(i) {
  const p = match.players[i];
  if (p.on) {
    p.minutes += Math.floor((match.secondsElapsed - p.lastOn) / 60);
    p.on = false;
    log(`${p.name} subbed off`);
  } else {
    p.on = true;
    p.lastOn = match.secondsElapsed;
    log(`${p.name} subbed on`);
  }
  renderLineup();
  persist();
}

function closeMinutes() {
  match.players.forEach(p => {
    if (p.on) {
      p.minutes += Math.floor((match.secondsElapsed - p.lastOn) / 60);
      p.lastOn = match.secondsElapsed;
    }
  });
}

/* ---------- RENDER ---------- */

function renderLineup() {
  lineupBody.innerHTML = "";
  match.players.forEach((p,i) => {
    const r = document.createElement("tr");
    r.innerHTML = `
      <td>${p.name}</td>
      <td>${p.on ? "On" : "Off"}</td>
      <td>${p.minutes}</td>
      <td><button onclick="togglePlayer(${i})">${p.on ? "Sub Off" : "Sub On"}</button></td>
    `;
    lineupBody.appendChild(r);
  });
}

/* ---------- TIMELINE ---------- */

function log(text) {
  match.timeline.push({ time: clockEl.textContent, text });
  renderTimeline();
}

function renderTimeline() {
  timelineBody.innerHTML = "";
  match.timeline.forEach(e => {
    const r = document.createElement("tr");
    r.innerHTML = `<td>${e.time}</td><td>${e.text}</td>`;
    timelineBody.appendChild(r);
  });
}

/* ---------- EXPORT ---------- */

function exportMinutes() {
  let csv = "Player,Minutes\n";
  match.players.forEach(p => csv += `${p.name},${p.minutes}\n`);

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${match.info.myTeam || "match"}_minutes.csv`;
  a.click();
}

/* ---------- PERSIST ---------- */

function persist() {
  match.info.myTeam = myTeamInput.value;
  match.info.opponent = opponentInput.value;

  localStorage.setItem("matches", JSON.stringify(matches));
  localStorage.setItem("currentMatchId", currentMatchId);
}

/* ---------- INIT ---------- */

if (!matches.length) {
  newMatch();
} else {
  loadMatch(currentMatchId || matches[0].id);
}
refreshMatchSelector();

/* ---------- SERVICE WORKER ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
