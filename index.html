<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Match Stats Tracker</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 12px;
}

h2, h3 {
  text-align: center;
  margin: 8px 0;
}

.section {
  background: white;
  padding: 12px;
  margin-bottom: 14px;
  border-radius: 8px;
}

input, button, select {
  font-size: 16px;
  padding: 10px;
}

button {
  min-height: 48px;
  width: 100%;
  margin-top: 6px;
}

.clock {
  font-size: 32px;
  text-align: center;
  margin: 10px 0;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
}

th {
  background: #eee;
}

@media (max-width: 600px) {
  .grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<h2>Match Stats</h2>

<div class="section grid">
  <input id="myTeam" placeholder="My Team">
  <input id="opponent" placeholder="Opponent">
</div>

<div class="section">
  <div class="clock" id="clock">00:00</div>
  <button id="startStop">Start Match</button>
  <button id="reset">Reset Match</button>
</div>

<div class="section">
  <h3>Lineup</h3>
  <input id="playerName" placeholder="Player name">
  <button onclick="addPlayer()">Add Player</button>

  <table>
    <thead>
      <tr>
        <th>Player</th>
        <th>Status</th>
        <th>Minutes</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="lineupBody"></tbody>
  </table>
</div>

<div class="section">
  <h3>Timeline</h3>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Event</th>
      </tr>
    </thead>
    <tbody id="timelineBody"></tbody>
  </table>
</div>

<script>
/* ---------------- STATE ---------------- */

let state = {
  running: false,
  secondsElapsed: 0,
  players: [],
  timeline: [],
  info: {}
};

let timer = null;

/* ---------------- DOM ---------------- */

const clockEl = document.getElementById("clock");
const startStopBtn = document.getElementById("startStop");
const resetBtn = document.getElementById("reset");
const lineupBody = document.getElementById("lineupBody");
const timelineBody = document.getElementById("timelineBody");

const myTeamInput = document.getElementById("myTeam");
const opponentInput = document.getElementById("opponent");
const playerNameInput = document.getElementById("playerName");

/* ---------------- CLOCK ---------------- */

function tick() {
  state.secondsElapsed++;
  updateClock();
  save();
}

function updateClock() {
  const m = Math.floor(state.secondsElapsed / 60);
  const s = state.secondsElapsed % 60;
  clockEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ---------------- MATCH CONTROL ---------------- */

startStopBtn.onclick = () => {
  state.running = !state.running;
  startStopBtn.textContent = state.running ? "Stop Match" : "Start Match";

  if (state.running) {
    state.players.forEach(p => {
      if (p.on) p.lastOnTime = state.secondsElapsed;
    });
    timer = setInterval(tick, 1000);
    log("Match Started");
  } else {
    clearInterval(timer);
    closeActiveMinutes();
    log("Match Stopped");
  }
  save();
};

resetBtn.onclick = () => {
  if (!confirm("Reset match?")) return;
  localStorage.removeItem("matchState");
  location.reload();
};

/* ---------------- PLAYERS ---------------- */

function addPlayer() {
  const name = playerNameInput.value.trim();
  if (!name) return;

  state.players.push({
    name,
    on: true,
    minutes: 0,
    lastOnTime: state.running ? state.secondsElapsed : null
  });

  log(`${name} added to lineup`);
  playerNameInput.value = "";
  renderLineup();
  save();
}

function togglePlayer(index) {
  const p = state.players[index];

  if (p.on) {
    // Sub off
    p.minutes += Math.floor((state.secondsElapsed - p.lastOnTime) / 60);
    p.on = false;
    p.lastOnTime = null;
    log(`${p.name} subbed off`);
  } else {
    // Sub on
    p.on = true;
    p.lastOnTime = state.secondsElapsed;
    log(`${p.name} subbed on`);
  }

  renderLineup();
  save();
}

function closeActiveMinutes() {
  state.players.forEach(p => {
    if (p.on && p.lastOnTime !== null) {
      p.minutes += Math.floor((state.secondsElapsed - p.lastOnTime) / 60);
      p.lastOnTime = state.secondsElapsed;
    }
  });
}

/* ---------------- RENDER ---------------- */

function renderLineup() {
  lineupBody.innerHTML = "";
  state.players.forEach((p, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${p.name}</td>
      <td>${p.on ? "On" : "Off"}</td>
      <td>${p.minutes}</td>
      <td><button onclick="togglePlayer(${i})">${p.on ? "Sub Off" : "Sub On"}</button></td>
    `;
    lineupBody.appendChild(row);
  });
}

/* ---------------- TIMELINE ---------------- */

function log(text) {
  const time = clockEl.textContent;
  state.timeline.push({ time, text });
  renderTimeline();
}

function renderTimeline() {
  timelineBody.innerHTML = "";
  state.timeline.forEach(e => {
    const row = document.createElement("tr");
    row.innerHTML = `<td>${e.time}</td><td>${e.text}</td>`;
    timelineBody.appendChild(row);
  });
}

/* ---------------- STORAGE ---------------- */

function save() {
  state.info = {
    myTeam: myTeamInput.value,
    opponent: opponentInput.value
  };
  localStorage.setItem("matchState", JSON.stringify(state));
}

function load() {
  const saved = localStorage.getItem("matchState");
  if (!saved) return;

  state = JSON.parse(saved);

  myTeamInput.value = state.info.myTeam || "";
  opponentInput.value = state.info.opponent || "";

  updateClock();
  renderLineup();
  renderTimeline();

  if (state.running) {
    timer = setInterval(tick, 1000);
    startStopBtn.textContent = "Stop Match";
  }
}

load();

/* ---------------- SERVICE WORKER ---------------- */

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
