<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Match Stats</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  margin: 0;
  padding: 10px;
}

h2, h3 {
  text-align: center;
  margin: 6px 0;
}

.section {
  background: #fff;
  padding: 10px;
  margin-bottom: 12px;
  border-radius: 8px;
}

input, button, select {
  font-size: 16px;
  padding: 10px;
}

button {
  min-height: 46px;
  margin-top: 6px;
}

.full {
  width: 100%;
}

.clock {
  font-size: 32px;
  text-align: center;
}

.scoreboard {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 28px;
  font-weight: bold;
}

.scoreboard span {
  flex: 1;
  text-align: center;
}

.badge {
  text-align: center;
  font-weight: bold;
  margin-bottom: 6px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px;
  text-align: center;
}

th {
  background: #eee;
}

.actions button {
  font-size: 14px;
  padding: 6px;
  margin: 2px;
}
</style>
</head>

<body>

<h2>Match Stats</h2>

<div class="section">
  <select id="matchSelector" class="full"></select>
  <button class="full" onclick="newMatch()">âž• New Match</button>
</div>

<div class="section">
  <input id="myTeam" class="full" placeholder="My Team">
  <input id="opponent" class="full" placeholder="Opponent">
</div>

<div class="section">
  <div class="scoreboard">
    <span id="homeName">HOME</span>
    <span id="score">0 - 0</span>
    <span id="awayName">AWAY</span>
  </div>
</div>

<div class="section">
  <div class="badge" id="phaseLabel">PRE MATCH</div>
  <div class="clock" id="clock">00:00</div>
  <button id="phaseButton" class="full">Start First Half</button>
</div>

<div class="section">
  <button class="full" onclick="addOpponentGoal()">âž• Opponent Goal</button>
</div>

<div class="section">
  <h3>Lineup</h3>
  <input id="playerName" class="full" placeholder="Player name">
  <button class="full" onclick="addPlayer()">Add Player</button>

  <table>
    <thead>
      <tr>
        <th>Player</th>
        <th>Status</th>
        <th>Min</th>
        <th>G</th>
        <th>A</th>
        <th>S</th>
        <th>T</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="lineupBody"></tbody>
  </table>
</div>

<div class="section">
  <h3>Timeline</h3>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Event</th>
      </tr>
    </thead>
    <tbody id="timelineBody"></tbody>
  </table>
</div>

<div class="section">
  <button class="full" onclick="exportCSV()">ðŸ“¤ Export CSV</button>
</div>

<script>
/* ---------- STORAGE ---------- */

let matches = JSON.parse(localStorage.getItem("matches") || "[]");
let currentMatchId = localStorage.getItem("currentMatchId");

/* ---------- MATCH TEMPLATE ---------- */

function createMatch() {
  return {
    id: Date.now(),
    info: { myTeam: "", opponent: "" },
    phase: "PRE_MATCH",
    seconds: 0,
    opponentGoals: 0,
    players: [],
    timeline: []
  };
}

/* ---------- STATE ---------- */

let match = null;
let timer = null;

/* ---------- DOM ---------- */

const clockEl = document.getElementById("clock");
const phaseLabel = document.getElementById("phaseLabel");
const phaseButton = document.getElementById("phaseButton");
const lineupBody = document.getElementById("lineupBody");
const timelineBody = document.getElementById("timelineBody");
const matchSelector = document.getElementById("matchSelector");

const myTeamInput = document.getElementById("myTeam");
const opponentInput = document.getElementById("opponent");
const playerNameInput = document.getElementById("playerName");

const scoreEl = document.getElementById("score");
const homeName = document.getElementById("homeName");
const awayName = document.getElementById("awayName");

/* ---------- MATCH SELECT ---------- */

function refreshSelector() {
  matchSelector.innerHTML = "";
  matches.forEach(m => {
    const o = document.createElement("option");
    o.value = m.id;
    o.textContent = `${m.info.myTeam || "Match"} vs ${m.info.opponent || ""}`;
    matchSelector.appendChild(o);
  });
  matchSelector.value = currentMatchId;
}

matchSelector.onchange = () => loadMatch(matchSelector.value);

/* ---------- MATCH CONTROL ---------- */

function newMatch() {
  if (match && !confirm("Start a new match? Current match is saved.")) return;
  match = createMatch();
  matches.push(match);
  currentMatchId = match.id;
  persist();
  loadMatch(match.id);
}

function loadMatch(id) {
  match = matches.find(m => m.id == id);
  if (!match) return;

  currentMatchId = id;
  persist();

  myTeamInput.value = match.info.myTeam;
  opponentInput.value = match.info.opponent;

  updateClock();
  updatePhaseUI();
  renderLineup();
  renderTimeline();
  updateScoreboard();

  if (timer) clearInterval(timer);
  if (["FIRST_HALF","SECOND_HALF"].includes(match.phase)) {
    timer = setInterval(tick, 1000);
  }
}

/* ---------- CLOCK ---------- */

function tick() {
  match.seconds++;
  updateClock();
  persist();
}

function updateClock() {
  const m = Math.floor(match.seconds / 60);
  const s = match.seconds % 60;
  clockEl.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

/* ---------- PHASE ---------- */

phaseButton.onclick = () => {
  if (match.phase === "PRE_MATCH") startHalf("FIRST_HALF");
  else if (match.phase === "FIRST_HALF") endHalf("HALF_TIME");
  else if (match.phase === "HALF_TIME") startHalf("SECOND_HALF");
  else if (match.phase === "SECOND_HALF") endHalf("FULL_TIME");
};

function startHalf(phase) {
  match.phase = phase;
  match.players.forEach(p => { if (p.on) p.lastOn = match.seconds; });
  timer = setInterval(tick, 1000);
  log(`${phase.replace("_"," ")} started`);
  updatePhaseUI();
  persist();
}

function endHalf(next) {
  closeMinutes();
  clearInterval(timer);
  match.phase = next;
  log(next.replace("_"," "));
  updatePhaseUI();
  persist();
}

/* ---------- PLAYERS ---------- */

function addPlayer() {
  const name = playerNameInput.value.trim();
  if (!name) return;

  match.players.push({
    name,
    on: true,
    minutes: 0,
    lastOn: match.seconds,
    stats: { goals: 0, assists: 0, shots: 0, tackles: 0 }
  });

  log(`${name} added`);
  playerNameInput.value = "";
  renderLineup();
  persist();
}

function togglePlayer(i) {
  const p = match.players[i];
  if (p.on) {
    p.minutes += Math.floor((match.seconds - p.lastOn) / 60);
    p.on = false;
    log(`${p.name} off`);
  } else {
    p.on = true;
    p.lastOn = match.seconds;
    log(`${p.name} on`);
  }
  renderLineup();
  persist();
}

function addStat(i, stat) {
  const p = match.players[i];
  p.stats[stat]++;
  if (stat === "goals") updateScoreboard();
  log(`${p.name} ${stat}`);
  renderLineup();
  persist();
}

/* ---------- OPPONENT GOALS ---------- */

function addOpponentGoal() {
  match.opponentGoals++;
  log("Opponent goal");
  updateScoreboard();
  persist();
}

/* ---------- SCOREBOARD ---------- */

function updateScoreboard() {
  const ourGoals = match.players.reduce((t,p) => t + p.stats.goals, 0);
  scoreEl.textContent = `${ourGoals} - ${match.opponentGoals}`;
  homeName.textContent = match.info.myTeam || "HOME";
  awayName.textContent = match.info.opponent || "AWAY";
}

/* ---------- MINUTES ---------- */

function closeMinutes() {
  match.players.forEach(p => {
    if (p.on) {
      p.minutes += Math.floor((match.seconds - p.lastOn) / 60);
      p.lastOn = match.seconds;
    }
  });
}

/* ---------- TIMELINE ---------- */

function log(text) {
  match.timeline.push({ time: clockEl.textContent, text });
  renderTimeline();
}

function renderTimeline() {
  timelineBody.innerHTML = "";
  match.timeline.forEach(e => {
    const r = document.createElement("tr");
    r.innerHTML = `<td>${e.time}</td><td>${e.text}</td>`;
    timelineBody.appendChild(r);
  });
}

/* ---------- EXPORT ---------- */

function exportCSV() {
  let csv = "Player,Minutes,Goals,Assists,Shots,Tackles\n";
  match.players.forEach(p => {
    csv += `${p.name},${p.minutes},${p.stats.goals},${p.stats.assists},${p.stats.shots},${p.stats.tackles}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${match.info.myTeam || "match"}_stats.csv`;
  a.click();
}

/* ---------- PERSIST ---------- */

function persist() {
  match.info.myTeam = myTeamInput.value;
  match.info.opponent = opponentInput.value;
  localStorage.setItem("matches", JSON.stringify(matches));
  localStorage.setItem("currentMatchId", currentMatchId);
}

/* ---------- INIT ---------- */

if (!matches.length) newMatch();
else loadMatch(currentMatchId || matches[0].id);
refreshSelector();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
